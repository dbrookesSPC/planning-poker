<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker Participation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding-top: 50px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Planning Poker - Participant</h1>
    <div id="voteSection">
        <input style="width: 200px;" type="number" id="voteInput" min="1" max="9" placeholder="Enter your vote (1-9)">
        <button id="submitVote">Submit Vote</button>
    </div>
    <div id="message" class="hidden"></div>

    <script>
let participantId = localStorage.getItem('participantId');

const joinServer = () => {
    console.log('Joining server', participantId)
    fetch(`/join${participantId ? `?id=${participantId}` : ''}`)
        .then(response => response.text())
        .then(id => {
            participantId = id;
            localStorage.setItem('participantId', id);
        });
};


        window.onload = function() {
            if (!participantId) {
    joinServer();
} else {
    // Optionally, verify or update the participant status on the server
    joinServer();
}
};
        const voteInput = document.getElementById('voteInput');
        const submitVote = document.getElementById('submitVote');
        const messageDiv = document.getElementById('message');

        // Submit Vote
        submitVote.onclick = function() {
            const vote = voteInput.value;
            if (vote >= 1 && vote <= 9) {
                fetch(`/vote?vote=${vote}&id=${participantId}`);
                voteInput.value = '';
                messageDiv.textContent = 'Vote submitted!';
                messageDiv.classList.remove('hidden');
            } else {
                messageDiv.textContent = 'Please enter a number between 1 and 9.';
                messageDiv.classList.remove('hidden');
            }
        };

        // SSE: Setup event source to listen for server-sent events
        const eventSource = new EventSource('/events');

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            switch (data.type) {
                case 'start':
                    messageDiv.textContent = 'Voting has started. Please submit your vote.';
                    messageDiv.classList.remove('hidden');
                    break;
                case 'end':
                    messageDiv.textContent = `Voting ended. Average vote: ${data.data}`;
                    messageDiv.classList.remove('hidden');
                    break;
                default:
                    // Handle other event types if necessary
                    break;
            }
        };
    </script>
</body>
</html>
